{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />

    <title>Thai School Alarm Web</title>
    <meta content="" name="description" />
    <meta content="" name="keywords" />

    <!-- Favicons -->
    <link href="{% static 'assets/img/favicon.png' %}" rel="icon" />
    <link href="{% static 'assets/img/apple-touch-icon.png' %}" rel="apple-touch-icon" />

    <!-- Google Fonts -->
    <link href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Itim&display=swap" rel="stylesheet" />

    <!-- Vendor CSS Files -->
    <link href="{% static 'assets/vendor/bootstrap/css/bootstrap.min.css' %}" rel="stylesheet" />
    <link href="{% static 'assets/vendor/bootstrap-icons/bootstrap-icons.css' %}" rel="stylesheet" />
    <link href="{% static 'assets/vendor/boxicons/css/boxicons.min.css' %}" rel="stylesheet" />
    <link href="{% static 'assets/vendor/quill/quill.snow.css' %}" rel="stylesheet" />
    <link href="{% static 'assets/vendor/quill/quill.bubble.css' %}" rel="stylesheet" />
    <link href="{% static 'assets/vendor/remixicon/remixicon.css' %}" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/simple-datatables@latest/dist/style.css" rel="stylesheet" type="text/css" />

    <!-- Template Main CSS File -->
    <link href="{% static 'assets/css/style.css' %}" rel="stylesheet" />

    <!--              =======================================================
  * Template Name: NiceAdmin
  * Template URL: https://bootstrapmade.com/nice-admin-bootstrap-admin-html-template/
  * Updated: Apr 20 2024 with Bootstrap v5.3.3
  * Author: BootstrapMade.com
  * License: https://bootstrapmade.com/license/
  ========================================================              -->
  </head>

  <body>
    <!-- ======= Header ======= -->
    <header id="header" class="header fixed-top d-flex align-items-center">
      <div class="d-flex align-items-center justify-content-between">
        <a href="/" class="logo d-flex align-items-center">
          <img src="{% static 'assets/img/logo.png' %}" alt="" />
          <span class="d-none d-lg-block">TSAlarm Web</span>
        </a>
        <i class="bi bi-list toggle-sidebar-btn"></i>
      </div>
      <!-- End Logo -->

      <div class="search-bar">
        <form class="search-form d-flex align-items-center" method="POST" action="#" onsubmit="handleFormSubmit(event)">
          <input type="text" name="query" placeholder="Search" title="Enter search keyword" />
          <button type="submit" title="Search"><i class="bi bi-search"></i></button>
        </form>
      </div>
      <!-- End Search Bar -->

      <nav class="header-nav ms-auto">
        <ul class="d-flex align-items-center">
          {% comment %} <li class="nav-item d-block d-lg-none">
            <a class="nav-link nav-icon search-bar-toggle" href="#"><i class="bi bi-search"></i></a>
          </li>
          <!-- End Search Icon --> {% endcomment %}

          {% comment %} <li class="nav-item dropdown">
            <a class="nav-link nav-icon" href="#" data-bs-toggle="dropdown">
              <i class="bi bi-bell"></i>
              <span class="badge bg-primary badge-number">4</span>
            </a><!-- End Notification Icon -->

            <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow notifications">
              <li class="dropdown-header">
                You have 4 new notifications
                <a href="#"><span class="badge rounded-pill bg-primary p-2 ms-2">View all</span></a>
              </li>
              <li>
                <hr class="dropdown-divider" />
              </li>

              <li class="notification-item">
                <i class="bi bi-exclamation-circle text-warning"></i>
                <div>
                  <h4>Lorem Ipsum</h4>
                  <p>Quae dolorem earum veritatis oditseno</p>
                  <p>30 min. ago</p>
                </div>
              </li>

              <li>
                <hr class="dropdown-divider" />
              </li>

              <li class="notification-item">
                <i class="bi bi-x-circle text-danger"></i>
                <div>
                  <h4>Atque rerum nesciunt</h4>
                  <p>Quae dolorem earum veritatis oditseno</p>
                  <p>1 hr. ago</p>
                </div>
              </li>

              <li>
                <hr class="dropdown-divider" />
              </li>

              <li class="notification-item">
                <i class="bi bi-check-circle text-success"></i>
                <div>
                  <h4>Sit rerum fuga</h4>
                  <p>Quae dolorem earum veritatis oditseno</p>
                  <p>2 hrs. ago</p>
                </div>
              </li>

              <li>
                <hr class="dropdown-divider" />
              </li>

              <li class="notification-item">
                <i class="bi bi-info-circle text-primary"></i>
                <div>
                  <h4>Dicta reprehenderit</h4>
                  <p>Quae dolorem earum veritatis oditseno</p>
                  <p>4 hrs. ago</p>
                </div>
              </li>

              <li>
                <hr class="dropdown-divider" />
              </li>
              <li class="dropdown-footer">
                <a href="#">Show all notifications</a>
              </li>
            </ul>
            <!-- End Notification Dropdown Items -->
          </li>
          <!-- End Notification Nav --> {% endcomment %}

          {% comment %} <li class="nav-item dropdown">
            <a class="nav-link nav-icon" href="#" data-bs-toggle="dropdown">
              <i class="bi bi-chat-left-text"></i>
              <span class="badge bg-success badge-number">3</span>
            </a><!-- End Messages Icon -->

            <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow messages">
              <li class="dropdown-header">
                You have 3 new messages
                <a href="#"><span class="badge rounded-pill bg-primary p-2 ms-2">View all</span></a>
              </li>
              <li>
                <hr class="dropdown-divider" />
              </li>

              <li class="message-item">
                <a href="#">
                  <img src="{% static 'assets/img/messages-1.jpg' %}" alt="" class="rounded-circle" />
                  <div>
                    <h4>Maria Hudson</h4>
                    <p>Velit asperiores et ducimus soluta repudiandae labore officia est ut...</p>
                    <p>4 hrs. ago</p>
                  </div>
                </a>
              </li>
              <li>
                <hr class="dropdown-divider" />
              </li>

              <li class="message-item">
                <a href="#">
                  <img src="{% static 'assets/img/messages-2.jpg' %}" alt="" class="rounded-circle" />
                  <div>
                    <h4>Anna Nelson</h4>
                    <p>Velit asperiores et ducimus soluta repudiandae labore officia est ut...</p>
                    <p>6 hrs. ago</p>
                  </div>
                </a>
              </li>
              <li>
                <hr class="dropdown-divider" />
              </li>

              <li class="message-item">
                <a href="#">
                  <img src="{% static 'assets/img/messages-3.jpg' %}" alt="" class="rounded-circle" />
                  <div>
                    <h4>David Muldon</h4>
                    <p>Velit asperiores et ducimus soluta repudiandae labore officia est ut...</p>
                    <p>8 hrs. ago</p>
                  </div>
                </a>
              </li>
              <li>
                <hr class="dropdown-divider" />
              </li>

              <li class="dropdown-footer">
                <a href="#">Show all messages</a>
              </li>
            </ul>
            <!-- End Messages Dropdown Items -->
          </li>
          <!-- End Messages Nav --> {% endcomment %}

          <li class="nav-item">
            <a class="nav-link nav-icon" href="#" data-bs-toggle="modal" data-bs-target="#terminalModal" title="terminal"><i class="bx bxs-terminal fs-4"></i></a>
          </li>

          <li class="nav-item">
            <a class="nav-link nav-icon" href="#" data-bs-toggle="modal" data-bs-target="#updateModal" title="อัพเดต">
              <i class="bx bxs-cloud-download fs-4"></i>
              <span id="update-badge" class="badge bg-danger badge-number d-none">1</span>
            </a>
          </li>

          <li class="nav-item dropdown pe-3">
            <a class="nav-link nav-profile d-flex align-items-center pe-0" href="#" data-bs-toggle="dropdown">
              <img src="{% static 'assets/img/profile-img.jpg' %}" alt="Profile" class="rounded-circle" />
              <span class="d-none d-md-block dropdown-toggle ps-2">K. Anderson</span>
            </a><!-- End Profile Iamge Icon -->

            <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow profile">
              <li class="dropdown-header">
                <h6>Kevin Anderson</h6>
                <span>Web Designer</span>
              </li>
              <li>
                <hr class="dropdown-divider" />
              </li>

              <li>
                <a class="dropdown-item d-flex align-items-center" href="#">
                  <i class="bi bi-person"></i>
                  <span>My Profile</span>
                </a>
              </li>
              <li>
                <hr class="dropdown-divider" />
              </li>

              <li>
                <a class="dropdown-item d-flex align-items-center" href="#">
                  <i class="bi bi-gear"></i>
                  <span>Account Settings</span>
                </a>
              </li>
              <li>
                <hr class="dropdown-divider" />
              </li>

              <li>
                <a class="dropdown-item d-flex align-items-center" href="#">
                  <i class="bi bi-question-circle"></i>
                  <span>Need Help?</span>
                </a>
              </li>
              <li>
                <hr class="dropdown-divider" />
              </li>

              <li>
                <a class="dropdown-item d-flex align-items-center" href="#">
                  <i class="bi bi-box-arrow-right"></i>
                  <span>Sign Out</span>
                </a>
              </li>
            </ul>
            <!-- End Profile Dropdown Items -->
          </li>
          <!-- End Profile Nav -->
        </ul>
      </nav>
      <!-- End Icons Navigation -->
    </header>
    <!-- End Header -->

    {% block sidebar %}

    {% endblock %}

    {% block main %}

    {% endblock %}

    <!-- ======= Footer ======= -->
    <footer id="footer" class="footer">
      <div class="copyright">
        &copy; Copyright <strong><span>ลองเขียนโค้ด</span></strong>. All Rights Reserved
      </div>
      <div class="credits">
        <!-- All the links in the footer should remain intact. -->
        <!-- You can delete the links only if you purchased the pro version. -->
        <!-- Licensing information: https://bootstrapmade.com/license/ -->
        <!-- Purchase the pro version with working PHP/AJAX contact form: https://bootstrapmade.com/nice-admin-bootstrap-admin-html-template/ -->
        Designed by <a href="mailto:poramin@kkumail.com">Kru Fame</a>
      </div>
    </footer>
    <!-- End Footer -->

    <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

    <!-- Bootstrap Modal HTML -->
    <div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="updateModalLabel">New Update Available</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">No update available</div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" id="updateButton" disabled><i class='bx bxs-cloud-download'></i> Update Now</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap Modal HTML -->
  <div class="modal fade" id="terminalModal" tabindex="-1" aria-labelledby="terminalModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
      <h5 class="modal-title" id="terminalModalLabel">Terminal</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <pre class="bg-dark text-light p-3 rounded" style="max-height:60vh; overflow:auto;">
              <code id="terminalOutput">Loading...</code>
            </pre>
          </div>
        </div>
      </div>
    </div>
    {% block modal %}

    {% endblock %}

    <!-- Vendor JS Files -->
    <script src="{% static 'assets/vendor/apexcharts/apexcharts.min.js' %}"></script>
    <script src="{% static 'assets/vendor/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
    <script src="{% static 'assets/vendor/chart.js/chart.umd.js' %}"></script>
    <script src="{% static 'assets/vendor/echarts/echarts.min.js' %}"></script>
    <script src="{% static 'assets/vendor/quill/quill.js' %}"></script>
    <script src="{% static 'assets/vendor/tinymce/tinymce.min.js' %}"></script>
    <script src="{% static 'assets/vendor/php-email-form/validate.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/simple-datatables@latest" type="text/javascript"></script>
    
    <!-- Template Main JS File -->
    <script src="{% static 'assets/js/main.js' %}"></script>

    <script>
      function handleFormSubmit(event) {
        event.preventDefault() // ป้องกันการส่งฟอร์ม
      }
      
      document.addEventListener('DOMContentLoaded', async function () {
        const currentURL = window.location.pathname // Get the current URL path
        const navLinks = document.querySelectorAll('.nav-item .nav-link') // Select all nav links
      
        // Loop through each link
        navLinks.forEach((link) => {
          const href = link.getAttribute('href') // Get href value from link
          if (currentURL === href) {
            // If the URL matches, remove the 'collapsed' class
            link.classList.remove('collapsed')
          }
        })
      })
      
     // Function to check if the last update check was today
      function shouldCheckForUpdate() {
        const lastCheckDate = localStorage.getItem('lastUpdateCheck')
        const today = new Date().toISOString().split('T')[0] // Get today's date (YYYY-MM-DD)

        return lastCheckDate !== today // Check if last check was today
      }

      function updateModal(){
        const updateButton = document.getElementById('updateButton')
        const updateBadge = document.getElementById('update-badge')
        try {
          updateAvailable = localStorage.getItem('updateAvailable') === 'true';
          compatiblePython = localStorage.getItem('compatiblePython');
          version_data = JSON.parse(localStorage.getItem('version_data'));
        } catch (error) {
          console.error("Error reading from localStorage:", error);
        }
      
        if (!version_data) {
          console.log('No version data available');
          return;
        }
      
        const currentVersion = version_data.version; // Local version  
        const latestVersion = version_data.latest_version; // GitHub version
        const releaseDate = version_data.release_date || 'Unknown'; // Provided by API
        const changelog = version_data.changelog ? version_data.changelog.join('<br>') : 'No details available'; // Provided by API
        
        // If an update is available, show update UI
        if (updateAvailable && compatiblePython) {
          // Update modal with version details
          const modalBody = document.querySelector('#updateModal .modal-body')
          modalBody.innerHTML = `<strong>New Version Available: ${latestVersion}</strong><br>
                                <strong>Release Date:</strong> ${releaseDate}<br><br>
                                <strong>Changelog:</strong><br>
                                ${changelog}`

          // Enable update button and show modal if not shown before
          updateButton.disabled = false
          if (!localStorage.getItem('lastUpdateVersion') || localStorage.getItem('lastUpdateVersion') !== latestVersion) {
            const updateModal = new bootstrap.Modal(document.getElementById('updateModal'))
            updateModal.show()
            localStorage.setItem('lastUpdateVersion', latestVersion)
          }

          // Show update badge
          updateBadge.classList.remove('d-none')
        } else {
          updateBadge.classList.add('d-none');
          console.log('No update available. Running latest version:', currentVersion)
        }
      }

      async function check_version(){
        fetch('/api/version/')
          .then((response) => response.json())
          .then((data) => {          
            const currentVersion = data.version // Local version  
            const updateAvailable = data.update_available // Boolean from API           
            const compatiblePython = data.compatible_python // Boolean from API

            // Save today's date to prevent duplicate checks
            localStorage.setItem('lastUpdateCheck', new Date().toISOString().split('T')[0])
            localStorage.setItem('lastUpdateVersion', currentVersion)
            localStorage.setItem('updateAvailable', updateAvailable)
            localStorage.setItem('compatiblePython', compatiblePython)

            // Hide update UI if Python is not compatible
            if (!compatiblePython) {
              console.log('Python version is not supported. Skipping update check.')
              localStorage.removeItem("version_data")
              return
            }else{
              localStorage.setItem('version_data', JSON.stringify(data))
            }
            updateModal();
          })
          .catch((error) => console.error('Error fetching version info from API:', error))
      }

      // --- Terminal log streaming helpers ---
      let logPollingInterval = null;
      let lastLogSnapshot = "";

      function updateTerminal(text) {
        const codeEl = document.getElementById('terminalOutput');
        if (!codeEl) return;
        // Update only if changed to reduce layout thrash
        if (text !== lastLogSnapshot) {
          codeEl.textContent = text || 'No log data available.';
          lastLogSnapshot = text;
          // Auto-scroll to bottom
          const pre = codeEl.closest('pre');
          if (pre) pre.scrollTop = pre.scrollHeight;
        }
      }

      function openTerminalModal() {
        const modalEl = document.getElementById('terminalModal');
        if (!modalEl) return;
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
      }

      function startLogPolling(pid) {
        if (!pid) return;
        if (logPollingInterval) clearInterval(logPollingInterval);

        const poll = () => {
          fetch(`/api/process/${pid}/`, { headers: { 'Content-Type': 'application/json' } })
            .then(r => {
              if (!r.ok) throw new Error(`HTTP ${r.status}`);
              return r.json();
            })
            .then(data => {
              updateTerminal(data.log || '');
              if (data.status === 'completed_or_not_found') {
                // Finished: clear storage and hard refresh
                clearInterval(logPollingInterval);
                logPollingInterval = null;
                try { localStorage.clear(); } catch (e) {}
                location.reload();
                return;
              }
              if (data.status && data.status !== 'running') {
                // Any other non-running status: stop polling and cleanup
                clearInterval(logPollingInterval);
                logPollingInterval = null;
                localStorage.removeItem('process_id');
              }
            })
            .catch(err => {
              updateTerminal(`Error fetching logs: ${err.message}`);
            });
        };

        // Initial immediate poll then interval
        poll();
        logPollingInterval = setInterval(poll, 1500);
      }

      // Backward-compatible checker (kept for safety): if a process is in progress, keep polling logs
      const checkProcess = () => {
        const pid = localStorage.getItem('process_id');
        if (!pid) return;
        startLogPolling(pid);
      };
      // เรียก checkProcess ทุก 3 วินาที เพื่อกู้ polling หากโดนเคลียร์โดยอุบัติเหตุ
      const pollingInterval = setInterval(checkProcess, 3000);
      


      // If we should check for updates, proceed
      if (shouldCheckForUpdate()) {
        check_version();
      } else {
        console.log('Skipping update check. Already checked today.')
        updateModal();
      }



        document.getElementById('updateButton').addEventListener('click', function() {
          // Disable button while request is being processed
          this.disabled = true;
          this.innerHTML = 'Updating...';

          // Hide update modal and show terminal modal immediately
          try {
            const updateModalEl = document.getElementById('updateModal');
            if (updateModalEl) {
              const updModal = bootstrap.Modal.getInstance(updateModalEl) || new bootstrap.Modal(updateModalEl);
              updModal.hide();
            }
          } catch (e) { /* no-op */ }

          openTerminalModal();
          updateTerminal('Starting update...');
        
          // ส่งคำขอไปที่ API /api/update/
          fetch('/api/update/')
            .then(response => response.json())
            .then(data => {
              if (data && data.process_id) {
                // Save process_id and open terminal to stream logs
                localStorage.setItem('process_id', data.process_id);
                startLogPolling(data.process_id);
              } else if (data && data.error) {
                // Windows or other error
                updateTerminal(`Update cannot start: ${data.error}`);
                this.disabled = false;
                this.innerHTML = '<i class="bx bxs-cloud-download"></i> Update Now';
              } else {
                updateTerminal('Failed to start update.');
                this.disabled = false;
                this.innerHTML = '<i class="bx bxs-cloud-download"></i> Update Now';
              }
            })
            .catch((error) => {
              console.error('Error:', error);
              updateTerminal(`Error: ${error.message}`);
              // คืนสถานะของปุ่มถ้ามีข้อผิดพลาด
              this.disabled = false;
              this.innerHTML = '<i class="bx bxs-cloud-download"></i> Update Now';
            });
        });

        // Resume log streaming if page reloaded while process running
        (function resumeLogsIfNeeded(){
          const pid = localStorage.getItem('process_id');
          if (pid) {
            openTerminalModal();
            startLogPolling(pid);
          }
        })();
       
    </script>
    {% block js %}

    {% endblock %}
  </body>
</html>